<!DOCTYPE html>
{% load static %}
<html>
<head>
    {% csrf_token %}

    <title>Upload to S3</title>
    <style>
        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #4CAF50;
        }

        .progress-container {
            width: 100%;
            background-color: #ddd;
            margin-bottom: 10px;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

</head>
<body>
    <input type="text" id="textInput" placeholder="Enter text here">
    <input type="file" id="fileInput" multiple>
    <button id="uploadButton">Upload</button>
    <div id="progressContainer"></div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.766.0.min.js"></script>
    <script>
        // Configure the AWS SDK with IAM user credentials
        AWS.config.update({
            region: 'us-east-1',
            credentials: new AWS.Credentials('AKIAUIIRW2M5LYBGGTI4', 'TkJJ3SYjSXLYbKAwtkbbCBChRL3oWbrmP3hdUIxD')
        });

        var s3 = new AWS.S3({
            apiVersion: '2006-03-01',
            params: { Bucket: 'creative-management' }
        });

        var uploadQueue = [];
        var isUploading = false;

        document.getElementById('uploadButton').addEventListener('click', function() {
            var textValue = document.getElementById('textInput').value;
            var files = document.getElementById('fileInput').files;
            if (textValue || files.length > 0) {
                uploadQueue.push({ text: textValue, files: Array.from(files) });
                if (!isUploading) {
                    processQueue();
                }
            }
        });

        function processQueue() {
            if (uploadQueue.length > 0) {
                isUploading = true;
                var item = uploadQueue.shift();
                uploadItem(item, function() {
                    processQueue();
                });
            } else {
                isUploading = false;
            }
        }

        function uploadItem(item, callback) {
            var totalSize = item.files.reduce((acc, file) => acc + file.size, 0);
            var uploadedSize = 0;
            var fileProgress = {};

            var progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            var progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressContainer.appendChild(progressBar);
            document.getElementById('progressContainer').appendChild(progressContainer);

            function updateProgress() {
                var progress = Math.round((uploadedSize / totalSize) * 100);
                progressBar.style.width = progress + '%';
            }

            function uploadNextFile() {
                if (item.files.length > 0) {
                    var file = item.files.shift();
                    var params = {
                        Key: file.name,
                        Body: file,
                        ACL: 'public-read'
                    };

                    var options = {
                        partSize: 10 * 1024 * 1024, // 10 MB
                        queueSize: 1
                    };

                    var upload = s3.upload(params, options);

                    upload.on('httpUploadProgress', function(event) {
                        if (!fileProgress[file.name]) {
                            fileProgress[file.name] = 0;
                        }
                        uploadedSize += event.loaded - fileProgress[file.name];
                        fileProgress[file.name] = event.loaded;
                        updateProgress();
                    });

                    upload.send(function(err, data) {
                        if (err) {
                            console.log('Error', err);
                            saveUploadInfo(file.name,'FAILED');
                        } else {
                            console.log('Upload Success', data.Location);
                            saveUploadInfo(file.name,data.Location);
                        }
                        uploadNextFile();
                    });
                } else {
                    callback();
                }
            }

            if (item.text) {
                // Handle text input here, e.g., save to a file or send to a server
                console.log('Text input:', item.text);
            }

            uploadNextFile();
        }




    </script>
    <script type="text/javascript">
        function saveUploadInfo(fileName,fileLocation) {
        $.ajax({
            url: 'save-upload-info/',
            type: 'POST',
            data: {
                'file_name': fileName,
                'file_location': fileLocation,
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            success: function(response) {
                console.log('Upload info saved:', response);
            },
            error: function(error) {
                console.log('Error saving upload info:', error);
            }
        });
    }
    </script>



</body>
</html>
